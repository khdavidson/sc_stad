---
title: "San Juan Background"
date: 'Last update: `r Sys.Date()`'
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
---

```{r setup, include=FALSE}
# >> If you get a 'Error: std::bad_alloc' message, close R and re-open <<

knitr::opts_chunk$set(echo=F, warning=F, message=F)

# Load packages -----------------------
#library(bookdown)             # for bookdown::html_document2
#library(tidyverse)
#library(httr)                 # for getNuSEDS()
#library(askpass)              # for getNuSEDS()
#library(readxl)
#library(openxlsx)             # for createWorkbook() etc
#library(kableExtra)           # for kable()
#library(janitor)              # for row_to_names()
#library(here)
#library(sf)                   # for mapping
#library(ggspatial)            # for mapping
#library(rnaturalearth)        # for mapping
#library(rnaturalearthdata)    # for mapping
#library(rnaturalearthhires)   # for mapping
#library(rgdal)                # for mapping
#library(scatterpie)           # for scatterplot mapping
#library(cowplot)

# Call source script -----------------------
source("san_juan_background.R", local = knitr::knit_global())
```

<br>

<br> 

# **Abundance and demographic traits of San Juan Chinook** {#sjchinook}

Status: 

* Recent average river adult spawners (last 10 yrs of available data): `r sj.esc %>% filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook",analysis_year>=(max(analysis_year-10)), est_type=="Natural Adult Spawners") %>% summarize(mean=round(mean(n,na.rm=T),0)) %>% pull(mean)`
  + Range: `r sj.esc %>% filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook",analysis_year>=(max(analysis_year-10)), est_type=="Natural Adult Spawners") %>% summarize(min=min(n)) %>% pull(min)` - `r sj.esc %>% filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook",analysis_year>=(max(analysis_year-10)), est_type=="Natural Adult Spawners") %>% summarize(max=max(n)) %>% pull(max)`
* Dominant age structure: 3, 4, 5 year olds
* Hatchery vs wild: uncertain due to historical marking/tagging process. Mostly unclipped with no thermal mark (but historical TM process highly unreliable)

<br>

## **Escapement and run timing** {#abundance}

San Juan Chinook escapement has varied over time. From its peak at 7500 in 1970 it declined to less than 2000 fish, but has since returned to escapements that oscillate around 2000-4000 fish (see Figure \@ref(fig:sj-ckesc-fig)). While broodstock collections were only documented in NuSEDS from 1995 onward, releases began in the 70's; see Enhancement Activity information (section \@ref(enhancement)) below. 

```{r sj-ckesc-fig, fig.cap='Total natural spawners (jack+adult) and broodstock removals for San Juan Chinook. Data from NuSEDS; excluding tributaries.'}
# FIGURE: SJ Chinook only ----------------------- 
ggplot() +
  #geom_segment(aes(x=1999,
  #                 xend=sj.esc %>% 
  #                   filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook", est_type=="Broodstock removals", !is.na(n)) %>% 
  #                   summarize(max=max(analysis_year))%>%
  #                   pull(max),
  #                 y=sj.esc %>% 
  #                   filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook",est_type%in%c("Natural spawners", "Broodstock removals"), 
  #                          analysis_year>=1998) %>% 
  #                   group_by(analysis_year) %>% 
  #                   summarize(sum=sum(n,na.rm=T)) %>% 
  #                   summarize(mean=mean(sum,na.rm=T)) %>%
  #                   pull(mean),
  #                 yend=sj.esc %>% 
  #                   filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook",est_type%in%c("Natural spawners", "Broodstock removals"), 
  #                          analysis_year>=1998) %>% 
  #                   group_by(analysis_year) %>% 
  #                   summarize(sum=sum(n,na.rm=T)) %>% 
  #                   summarize(mean=mean(sum,na.rm=T)) %>%
  #                   pull(mean)),
  #             colour="red", size=1, linetype="solid") +
  geom_bar(data=sj.esc %>% filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook", est_type%in%c("Natural spawners", "Broodstock removals")), 
           aes(x=as.numeric(analysis_year), y=as.numeric(n), group=est_type, fill=est_type),
           stat="identity", position="stack", size=0.7, width=1, colour="black") +
  scale_y_continuous(breaks=seq(0,8000,by=1000)) +
  scale_x_continuous(breaks=seq(min(sj.esc$analysis_year), max(sj.esc$analysis_year), by=7)) +
  scale_fill_manual(breaks = c("Natural spawners", "Broodstock removals"), values=c("dodger blue","orange")) +
  labs(x="Return Year", y="Number of San Juan Chinook") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=10),
        axis.title = element_text(face="bold", size=12),
        panel.grid = element_blank(),
        legend.position = c(0.8,0.9),
        legend.background = element_rect(colour="black"),
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        plot.caption = element_text(hjust=0, face="italic"))
```

```{r sj-esc-fig, fig.cap='Total natural spawners (jack+adult) and broodstock removals for all species in the San Juan. Vertical dashed lines indicate periods of enhancement. Long-term averages (solid gray line) are calculated across the whole time series since enhancement began. Recent averages (black line) are calculated from the most recent 5 years of complete data. Data from NuSEDS; excluding tributaries. Red outlined bars indicate recent and/or preliminary escapement estimates not yet in NuSEDS.'}
# FIGURE: All species ----------------------- 
ggplot() +
  geom_vline(data=mile4.releases%>%group_by(SPECIES_NAME)%>%summarize(start=min(BROOD_YEAR))%>%rename(Species=SPECIES_NAME)%>%
               mutate(n=c(7000,10000,70000)),
             aes(xintercept=start), colour="gray60", linetype="dashed", size=0.5) +
  
  geom_vline(data=mile4.releases%>%group_by(SPECIES_NAME)%>%summarize(end=max(BROOD_YEAR))%>%rename(Species=SPECIES_NAME)%>%
               mutate(n=c(7000,10000,70000), end=ifelse(Species=="Chinook", NA, end)),
             aes(xintercept=end), colour="gray60", linetype="dashed", size=0.5) +
  
  
  # ******* UPDATE THIS ONCE HEAR BACK FROM CARRIE HOLT *********
  geom_hline(data=data.frame(Species="Chinook", Smsy=2200, Sgen=990, Srep=5200), aes(yintercept=Smsy), size=1, linetype="dashed") +
  
  #geom_line(data=sj.esc%>%filter(waterbody_name%in%c("SAN JUAN RIVER","San Juan"), est_type%in%c("Natural spawners", "Broodstock removals"), 
  #                               Species%in%c("Chinook","Chum","Coho"),
  #                               (Species=="Chinook"&analysis_year>=1979+3)|(Species=="Chum"&analysis_year>=1995+4)|
  #                                 (Species=="Coho"&analysis_year>=1982+3),
  #                               analysis_year<2022, !is.na(n))%>%
  #            group_by(analysis_year,Species)%>%summarize(total=sum(n,na.rm=T))%>%group_by(Species)%>%
  #            mutate(mean_spawners=round(mean(total,na.rm=T),0)),
  #           aes(x=analysis_year, y=mean_spawners), colour="gray40", size=1) +
  
    #geom_line(data=sj.esc%>%filter(waterbody_name%in%c("SAN JUAN RIVER","San Juan"), est_type=="Natural spawners", 
    #                               !is.na(n), analysis_year<2022, Species%in%c("Chinook","Chum","Coho"),) %>%
    #            group_by(Species) %>% slice_max(analysis_year, n=5) %>% group_by(Species)%>%mutate(mean_spawners=round(mean(n,na.rm=T),0)),
    #         aes(x=analysis_year, y=mean_spawners), colour="black", size=1) +
  
  #geom_line(data=sj.esc%>%filter(waterbody_name%in%c("SAN JUAN RIVER","San Juan"), est_type=="Natural spawners", !is.na(n),
  #                               (Species=="Chinook" & analysis_year%in%c((max(analysis_year)-4):max(analysis_year)))|
  #                                 (Species=="Chum" & analysis_year%in%c((max(analysis_year)-4):max(analysis_year)))|
  #                                 (Species=="Coho" & analysis_year%in%c((max(analysis_year)-3):max(analysis_year))))%>%
  #             group_by(Species)%>%mutate(mean_spawners=round(mean(n,na.rm=T),0)),
  #           aes(x=analysis_year, y=mean_spawners), colour="black", size=1) +
  
  geom_bar(data=sj.esc%>%filter(waterbody_name=="SAN JUAN RIVER",est_type%in%c("Natural spawners", "Broodstock removals"),source=="NuSEDS",
                                Species%in%c("Chinook","Chum","Coho"),), 
           aes(x=analysis_year, y=as.numeric(n), fill=est_type, colour=est_type), stat="identity", alpha=0.8, width=0.9,size=0.3) +
  geom_bar(data=sj.esc%>%filter(est_type%in%c("Natural spawners", "Broodstock removals"),source=="New Esc Index",
                                Species%in%c("Chinook","Chum","Coho")), 
           aes(x=analysis_year, y=n, fill=est_type, colour=est_type), stat="identity", alpha=0.7, width=0.9, size=0.5) +
  
    geom_bar(data=sj.esc%>%filter(est_type%in%c("Natural spawners", "Broodstock removals"),source=="New Esc Index",
                                Species%in%c("Chinook","Chum","Coho"),analysis_year==2022)%>%group_by(analysis_year,Species)%>%summarize(total=sum(n)), 
           aes(x=analysis_year, y=total), stat="identity", width=0.9, size=0.7, fill="transparent", colour="red") +
  
  scale_x_continuous(breaks=seq(min(sj.esc$analysis_year), max(sj.esc$analysis_year), by=7)) +
  scale_fill_manual(breaks = c("Natural spawners", "Broodstock removals"), values=c("dodger blue","orange")) +
  scale_colour_manual(breaks = c("Natural spawners", "Broodstock removals"), values=c("dodger blue","orange")) +
  labs(x="Return Year", y="Number of fish", group="Number of fish") +
  theme_bw() +
  theme(axis.text = element_text(colour="black",size=17),
        axis.text.x = element_text(angle=45,hjust=1),
        axis.title = element_text(face="bold",size=19),
        panel.grid.major.y = element_line(colour="gray70"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.position = c(0.75,0.2),
        #legend.direction = "horizontal",
        legend.background = element_blank(),
        strip.text = element_text(size=15)) +
  facet_wrap(~Species, scales="free", nrow=2) +
  guides(colour = guide_legend(override.aes=list(colour=NA))) 
```


<br>

In 2022, the expanded escapement count from swims was 494 adults. In contrast, the fence only passed 251 through upstream. A total of 407 fish were taken for broodstock, of which 86 died (49M, 37F) due to low oxygen/high river temps. 

```{r sj22-esc, fig.cap='Raw Chinook fence and swim counts and river gauge level (m) for 2022.'}
plot_grid(
  ggplot(data=sjWater %>% 
           mutate(doy = lubridate::yday(date)) %>%
           group_by(date) %>%
           summarize(mean=mean(`Sensor Depth(mH20)`,na.rm=T), sd=sd(`Sensor Depth(mH20)`,na.rm=T),
                     min=min(`Sensor Depth(mH20)`,na.rm=T), max=max(`Sensor Depth(mH20)`,na.rm=T))) +
    geom_ribbon(aes(x=as.Date(date), ymin=min, ymax=max), fill="dodger blue", alpha=0.2) +
    geom_line(aes(x=as.Date(date), y=mean), size=1, colour="dodger blue",alpha=0.7) +  
    labs(y="Water gauge level (m)") +
    scale_y_continuous(breaks=seq(1,4,by=0.5)) +
    scale_x_date(date_breaks="1 day", date_labels="%b %d", limits=c(as.Date("2022-09-24"), as.Date("2022-11-20"))) +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.title = element_text(face="bold", size=20),
          axis.text = element_text(colour="black", size=17),
          panel.grid.minor = element_blank()),
  
  ggplot() +
    geom_bar(data=SJsum2022 %>% 
               filter(Segment=="San Juan fence", Species=="Chinook") %>%
               group_by(Date) %>%
               summarize(total=sum(Total,na.rm=T)) %>% 
               mutate(cuml_total = cumsum(total)), 
             aes(x=as.Date(Date), y=cuml_total), stat="identity", fill="gray40", width=1,alpha=0.3) +
    geom_bar(data=SJsum2022 %>% 
               filter(Segment=="San Juan fence", Species=="Chinook") %>%
               group_by(Date) %>%
               summarize(total=sum(Total,na.rm=T)) , 
             aes(x=as.Date(Date), y=total), stat="identity", fill="gray40", width=1) +
    geom_bar(data=SJsum2022 %>% 
               filter(survey_cycle!="San Juan fence") %>% 
               group_by(survey_cycle, cycle_date, Species) %>%
               summarize(holding=sum(`# Holding`,na.rm=T), spawning=sum(`# Spawning`,na.rm=T), total=sum(Total,na.rm=T)) %>% 
               pivot_longer(cols=holding:total, names_to = "behaviour", values_to = "n") %>%
               filter(behaviour!="total", Species=="Chinook"),
             aes(x=as.Date(cycle_date), y=n, fill=behaviour), stat="identity", width=1) +
    scale_x_date(date_breaks="2 day", date_labels="%b %d", limits=c(as.Date("2022-09-24"), as.Date("2022-11-20"))) +
    labs(y="Raw # Chinook") +
    annotate(geom="text", x=as.Date("2022-10-03"), y=300, label="cumulative fence count", colour="gray50", hjust = 0, size=6) +
    annotate(geom="text", x=as.Date("2022-10-11"), y=150, label="daily fence count", colour="gray10", hjust = 0, size=6) +
    annotate(geom="text", x=as.Date("2022-10-27"), y=350, label="swim count\n(cycle 1)", colour="#20b2aa", hjust = 0, size=6) +
    annotate(geom="text", x=as.Date("2022-11-17"), y=50, label="swim count\n(cycle 2)", colour="#20b2aa", hjust = 0, size=6) +
    
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1),
          axis.title.x = element_blank(),
          axis.title = element_text(face="bold", size=20),
          axis.text = element_text(colour="black", size=17),
          legend.position = c(0.8,0.7),
          legend.title = element_text(face="bold", size=17),
          legend.text = element_text(size=15),
          legend.background = element_rect(colour="black"),
          panel.grid.minor = element_blank()),
  
  #  ggplot() +
  #    geom_bar(data=SJsum2022  %>% 
  #               filter(survey_cycle!="San Juan fence") %>%
  #               group_by(survey_cycle, cycle_date, Species) %>%
  #               summarize(new=mean(`%New`,na.rm=T)+0.001) %>% 
  #               filter(Species=="Chinook"),
  #             aes(x=as.Date(cycle_date), y=new), stat="identity", width=1, fill="green") +
  #    scale_x_date(date_breaks="1 day", date_labels="%b %d", limits=c(as.Date("2022-09-24"), as.Date("2022-11-20"))) +
  #    scale_y_continuous(limits=c(0,0.5), labels = scales::percent) +
  #    labs(y="% New chinook") +
  #    theme_bw() +
  #    theme(axis.text.x = element_text(angle=45, hjust=1),
  #          axis.title.x = element_blank(),
  #          axis.title = element_text(face="bold"),
  #          axis.text = element_text(colour="black"),
  #          legend.background = element_rect(colour="black"),
  #          panel.grid.minor = element_blank()),
  
  # ggplot() +
  #    geom_bar(data=SJsum2022  %>% 
  #               filter(is.na(Comments), Species=="Chinook", survey_cycle!="San Juan fence") %>%
  #               group_by(survey_cycle, cycle_date) %>%
  #               summarize(dead=sum(Dead,na.rm=T),Total=sum(Total,na.rm=T)) %>% 
  #               mutate(ratioDL = ifelse(dead>0,dead/Total,0.0001)),
  #             aes(x=as.Date(cycle_date), y=ratioDL), 
  #             stat="identity", width=1, fill="maroon") +
  #    scale_x_date(date_breaks="1 day", date_labels="%b %d", limits=c(as.Date("2022-09-24"), as.Date("2022-11-20"))) +
  #    labs(y="Ratio of live:dead Chinook") +
  #    theme_bw() +
  #    theme(axis.text.x = element_text(angle=45, hjust=1),
  #          axis.title.x = element_blank(),
  #          axis.title = element_text(face="bold"),
  #          axis.text = element_text(colour="black"),
  #          legend.background = element_rect(colour="black"),
  #          panel.grid.minor = element_blank()),
  
  nrow=2
)
```

<br>

The 2022 returns came from the following brood-year strength:

```{r by-tab}
sj.esc %>% 
  filter( (Species=="Chinook" & analysis_year%in%c(2016:2018))|
            (Species=="Coho" & analysis_year==2019)|
            (Species=="Chum" & analysis_year==2018)|
            (Species=="Sockeye" & analysis_year==2018)|
            (Species=="Pink" & analysis_year==2020), 
          est_type%in%c("Natural spawners","Broodstock removals")) %>%
  group_by(Species, waterbody_name,analysis_year)%>%
  summarize(total=sum(n,na.rm=T))
```


Most chinook are observed in the San Juan between the third week of September (statweek 93) and the second week of October (statweek 102) (Figure \@ref(fig:sj-timing)). Most counts come from a combination of the fence (which is usually in until first or second week of October) and swim surveys (often later, but not always). The years that are swim survey only are `r sj.ck.timing %>% filter(method=="swim")%>%group_by(year)%>%summarize(n())%>%pull(year)`. 

```{r sj-timing, fig.cap='Chinook counts through the fence and/or swim surveys in the San Juan River from 1995-2021 inclusive. Counts are more representative of arrival rather than peak spawning (no documentation of behaviour accompanies counts). Stock Assessment data.'}
ggplot(sj.ck.timing %>% mutate(year_group=case_when(year<2000~"pre 2000",
                                                    year%in%c(2000:2010) ~ "2000-2010",
                                                    year>2010~"post-2010"),
                               year_group = factor(year_group, levels=c("pre 2000", "2000-2010", "post-2010",ordered=T))), 
       aes(x=stat_week, y=count, group=year, fill=year_group, colour=year_group)) +
  geom_bar(stat="identity", alpha=0.7) +
  labs(x="Stat week", y="Count") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        legend.title = element_blank())
```

<br>

<br>

## **Age structure**  {#escAge}

The adult age structure is primarily 3, 4 and 5 year olds. Jacks and 6 year olds contribute minimally to the population, especially in recent years (see Table \@ref(tab:age-tab) and Figure \@ref(fig:age-fig)). 

<br>

```{r age-tab, echo=F, warning=F, message=F}
# TABLE: Overall age structure -----------------------
sj.age %>% 
  group_by(`Fiscal Year`, resolved_age) %>% 
  summarize(n=n()) %>% 
  group_by(`Fiscal Year`) %>% 
  mutate(propn=n/sum(n)) %>%
  group_by(resolved_age) %>% 
  summarize(avg_propn = mean(propn), sd_propn=sd(propn)) %>% 
  mutate(avg_propn=round(avg_propn,3)*100, sd_propn=round(sd_propn,3)*100) %>%
  unite(col="Average proportion (± SD)", c(avg_propn, sd_propn), sep=" ± ") %>%
  rename(Age=resolved_age) %>%
  kbl(align="c", caption="Age structure of San Juan Chinook (excludes tributaries). Data from NuSEDS.") %>%
  kable_paper("hover", full_width=T, position = "center") 
```

<br>

```{r age-fig, echo=F, warning=F, message=F, fig.cap='Annual age structure of San Juan Chinook (excludes tributaries). Data from NuSEDS.'}
# FIGURE: AGE ~ TIME ----------------------- 
ggplot(sj.age %>% 
         group_by(`Fiscal Year`, resolved_age) %>% 
         summarize(n=n()) %>% 
         group_by(`Fiscal Year`) %>% 
         mutate(propn=n/sum(n)),
       aes(x=`Fiscal Year`, y=propn, group=as.factor(resolved_age), fill=as.factor(resolved_age), colour=as.factor(resolved_age))) +
  geom_bar(stat="identity", position="stack", width=0.5, alpha=0.8, size=1) +
  labs(y="Proportion", fill="Age:", colour="Age:") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=11),
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(face="bold", size=13),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(face="bold"),
        plot.caption = element_text(face="italic", hjust=0))
```

<br>

<br>

## **Hatchery vs. natural-origin (in escapement only)**   {#escOrigin}

Hatchery-origin San Juan chinook have contributed minimally to otolith samples from escapements in the last few years, but have been a large proportion of samples prior to 2014 (see Table \@ref(tab:escOrigin-tab) and Figure \@ref(fig:escOrigin-fig)). This is because San Juan BYs 2014-2017 were not thermally marked (or were poorly/partially marked). See PNI discussions below (section \@ref(PNI)). 

<br>

```{r escOrigin-tab, echo=F, warning=F, message=F}
# TABLE: Origin of chinook in escapements ---------------
sj.otoTM.rcvy %>%
  kbl(align="c", caption="Hatchery and unmarked ('N/unk') components of San Juan escapement for years available. Data from OtoManager.") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1,2,3), valign="middle") 
```

<br>

```{r escOrigin-fig, echo=F, warning=F, message=F, fig.cap='Proportion of Chinook recovered in the San Juan River that are hatchery (blue) and natural/unknown (pink) origin based on otolith thermal mark recoveries. Overlapping shading represents occasional small number of hatchery strays encountered. This does not take into account marking/release effort and strategies; it is important to consider thermal marking strategies/effort detailed below.'}
# FIGURE: Origin of chinook in escapements ---------------
ggplot() +
  geom_bar(data=sj.otoTM.rcvy, aes(x=`SAMPLE YR`, y=`Propn (%)`, group=`Hatchery origin?`, fill=`Hatchery origin?`, colour=`Hatchery origin?`), stat="identity", position="stack", alpha=0.7, size=1) +
  #geom_point(data=sj.otoTM.refNAs, aes(x=as.numeric(BROOD.YEAR), y=link), size=2) +
  labs(x="Sample year", y="Proportion in oto TM recoveries (%)") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        plot.caption = element_text(hjust=0, face="italic"),
        panel.grid = element_blank()) +
  facet_wrap(.~SOURCE, nrow = 2, scales="free")
```

<br>

### **PNI**  {#PNI}

Given the uncertainty in thermal mark quality from BYs 2014-2017 and 2020 (which will contribute to fisheries and escapements from 2016-2025, approximately), it is difficult to estimate PNI for San Juan Chinook. From Jacob Weil: 

> PNI.tot is the value of PNI that SEP would have (includes all fish returning to the river) and PNI.local is a value derived by me that shows what the PNI would be if all strayed fish were excluded in the calculation. In 2015, we have NA values because we do not have data for pNOB... Strayed fish (not from San Juan hatchery production), are not often a significant proportion of the escapement estimate and thus do not depress PNI values substantially.

In recent years, the San Juan PNI has varied around 0.1-0.4 (Table \@ref(tab:pni-tab) and Figure \@ref(fig:pni-plot)).

```{r pni-tab, echo=F, message=F, warning=F}
# TABLE: pHOS, pNOB and PNI ~ year ------------------
sj.pni %>%
  kbl(align="c", caption="Proportion of hatchery-origin chinook in spawners (pHOS) and resulting Proportion of Natural Influence (PNI) for San Juan Chinook. Data from Jacob Weil, DFO.") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1), valign="middle") 
```

<br>

```{r pni-plot, echo=F, message=F, warning=F, fig.cap='Hatchery-origin (HOS) and natural-origin (NOS) adult Chinook spawners in the San Juan River and resulting PNI.local (black). HOS calculated from Adult Spawners x pHOS, and NOS from Adult Spawners x (1-pHOS) from Table 3 above.'}
# FIGURE: PNI ~ time and escapement ------------------
ggplot() +
  geom_bar(data=sj.pni.plot %>% pivot_longer(cols=c(HOS, NOS), names_to = "source", values_to = "n_spawners") %>% 
             mutate(source = ifelse(is.na(pHOS), "Total spawners", source), n_spawners = ifelse(source=="Total spawners", `Adult Spawners`, n_spawners)) %>% 
             group_by(Year, source)%>% 
             summarize(n_spawners=sum(n_spawners)) %>% filter(Year>=2005), 
           aes(x=Year, y=n_spawners, group=Year, colour=source, fill=source), stat="identity", position="stack", alpha=0.6, size=1) +
  geom_line(data=sj.pni.plot%>%filter(!is.na(PNI.local)), aes(x=Year, y=PNI.local*10000), size=1, alpha=0.5) +
  geom_point(data=sj.pni.plot%>%filter(!is.na(PNI.local)), aes(x=Year, y=PNI.local*10000), size=3, shape=21, alpha=0.8, stroke=1, colour="black", fill="black") +
  scale_y_continuous(sec.axis = sec_axis(~./10000, name = "PNI")) +
  scale_x_continuous(breaks=seq(2004,2020,by=1)) +
  scale_colour_manual(values=c("#F8766D", "#00BFC4", "gray50")) +
  scale_fill_manual(values=c("#F8766D", "#00BFC4", "gray50")) +
  labs(x="Brood year", y="Adult Chinook spawner abundance") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(colour="black", size=11),
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(face="bold", size=13),
        legend.position = c(0.8,0.80),
        legend.background = element_rect(colour="black"),
        legend.title = element_blank(),
        plot.caption = element_text(hjust=0, face="italic"))
```

<br>

<br> 







------------------------

<br>

# **San Juan Chinook enhancement**   {#enhancement}

The 4 Mile Creek Enhancement Society operates the 4 Mile Hatchery to enhance San Juan chinook. The current board of directors is composed of the society members, hatchery managers, Pacheedaht and Mosaic representatives. The hatchery is modest in its capacity to produce chinook. Releases are typically less than 1 million and are usually smolts (sometimes fed fry). Current release goals are approximately 460,000 chinook smolts. Historically they have also enhanced chum and coho, but have not in recent years (no adult returns are from hatchery parents). 

Rearing and release strategies/locations have been variable over time. Currently the hatchery operates two main rearing/release strategies: lake and sea pen. All juveniles are incubated and reared in the hatchery until water supply becomes an issue (4 Mile Hatchery runs on a combination of creek surface water and well water). Once flows decline, the majority of juveniles (~400k) are transferred to the Fairy Lake pen for the remainder of their growing time until release. They are fed while in the lake pen. Historically this lake group has not been marked or tagged consistently. A small group (~40k) is held back at the hatchery where the remaining water supply can be diverted to the few rearing tanks for this group. This small group will be raised a while longer on the remaining hatchery water supply, and then transferred to the Port Renfrew seapen at East Point, where they rear until they reach target release size. This seapen group is 100% CWT and ad-clipped, and is meant to imprint on the nearshore marine environment; the holding/staging of returning adults for a longer period in the marine environment is meant to facilitate a mark-selective fishery for both Pacheedaht and sport fishermen. 

In 2023, we are hoping to CWT and adipose clip all 40,000 seapen releases, and CWT an additional 40,000 (unmarked) lake pen fish. Due to the logistics of having fish on-hand/accessible to tag, all 80k will be held back at the hatchery until large enough to tag. The success of the lake pen tagging will depend on how closely we are able to mimic the rest of the lake group (~360k), specifically with size. These lake fish will be put in the lake to rear as long as possible, and released with the rest of the cohort. The question here will have to be focused more on relative survival/recovery of release strategy (i.e., location) rather than rearing strategy (i.e., do these 2 release groups have different recovery rates in fisheries/escapement). 

See below for release dates, weights (although these may be wrong apparently, according to 4 Mile)

<br>

<br>

## **Broodstock collection and release groups** {#broodRelease}

Figure \@ref(fig:sj-esc-fig) shows brood collections over time (as documented in NuSEDS). Hatchery releases from SEP are documented back to 1995, but MRP contains San Juan CWT records dating back to BY 1979. From 2013-2017 all seapean releases were marked, but the seapen has not been used in recent years (although hopes to be used for BY 2022/RY 2023). The majority of San Juan chinook releases are unmarked (Table \@ref(tab:release-tab) and Figure \@ref(fig:release-fig)). 

```{r release-tab, echo=F, warning=F, message=F}
# Just Releases ----------------------- 
mile4.releases %>%
  arrange(SPECIES_NAME, BROOD_YEAR) %>% 
  filter(SPECIES_NAME!="Coho" | !BROOD_YEAR%in%c(1995:1997) | source!="MRP") %>%
  #filter(!grepl("Harris", `Release Site Name`)) %>%
  group_by(SPECIES_NAME, BROOD_YEAR, FACILITY_NAME) %>% 
  summarize(CWT_AD=sum(CWT_AD), AD_only=sum(AD_only), unmarked=sum(unmarked), total_release=sum(total_release)) %>% 
  mutate(across(CWT_AD:total_release, ~ format(., big.mark=",", scientific=F))) %>%
  #select(FACILITY_NAME,BROOD_YEAR,CWT_AD:`unmarked %`)%>%
  kbl(align="c", caption="Hatchery releases and marking information for San Juan and tributary Chinook. Data from SEP. It is assumed all broodstock was collected from the San Juan River, with different release strategy locations indicated by 'Release Site Name' (Port Renfrew = juveniles reared in the sea netpen). Data from MRP and SEP.") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1,2), valign="middle")
```

<br>

```{r release-fig, message=F, warning=F, echo=F, fig.cap='Chinook hatchery releases (bars) relative to escapement and broodstock collections. Year corresponds to return year for natural spawners/broodstock removals, and brood year for hatchery release groups (note that the actual year of release would be +1, e.g., releases from fall 2020 would be released spring 2021). Release data from SEP and MRP, escapement data from NuSEDS.'}
ggplot() +
  geom_bar(data=mile4.releases, aes(x=as.numeric(BROOD_YEAR), y=total_release/200, fill=`Release Site Name`), stat="identity", alpha=0.3) +
  geom_line(data=sj.esc%>%filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook", est_type%in%c("Broodstock removals","Natural spawners")), 
            aes(x=as.numeric(analysis_year), y=as.numeric(n), group=est_type, colour=est_type), size=1.2, alpha=0.7) +
  #geom_point(data=sj.esc%>%filter(waterbody_name=="SAN JUAN RIVER", Species=="Chinook"), 
  #           aes(x=as.numeric(analysis_year), y=as.numeric(n), group=est_type, fill=est_type, colour=est_type), size=3, stroke=1.2, alpha=0.7) +
  scale_x_continuous(breaks=seq(min(sj.esc$analysis_year), max(sj.esc$analysis_year), by=3)) +
  scale_y_continuous(limits=c(0,8000), breaks=seq(0,8000,by=2000), sec.axis = sec_axis(~ . * 200, name = "Hatchery releases")) +
  labs(x="", y="Number of spawning adult Chinook", caption="Fig 3. ") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=11),
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(face="bold", size=13),
        panel.grid = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.15,0.7),
        legend.background = element_rect(colour="black", fill="transparent"),
        legend.key = element_rect(fill="transparent"),
        plot.caption = element_text(face="italic", hjust=0)) 
```

<br>

<br>

## **Size and timing of juveniles at release** {#releases}

Smolts released from the seapean are released later (Figure @\ref(fig:release-time-fig)) and heavier (Figure @\ref(fig:release-size-fig)) than their siblings released from the lakepen. Across years, seapen smolts average 10.2 ± 1.35g while lakepen smolts average 7.25 ± 0.58g (Figure @\ref(fig:release-size-fig)). 

```{r release-time-fig, fig.cap='Earliest release date by rearing strategy. Individual points represent years. Data from SEP.'}
# FIGURE: Release stages ~ time ---------------------
ggplot(sj.rel.bio, aes(x=as.Date(start_DOY, origin="1995-01-01"), y=RELEASE_STAGE_NAME, fill=RELEASE_STAGE_NAME, colour=RELEASE_STAGE_NAME, group=RELEASE_YEAR)) +
  geom_point(shape=21, size=4, alpha=0.7) +
  scale_x_date(date_labels="%B %d", date_breaks="7 days") +
  labs(y="Release stage", x="Earliest release date") +
  theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(face="bold"),
        axis.text.x = element_text(colour="black", angle=45, hjust=1))
```

<br>

```{r release-size-fig, fig.cap='Average weight (g) by rearing strategy. Data from SEP. **Note these data are likely incorrect based on discussions with SEP and 4 Mile.**'}
# FIGURE: weight ~ rearing strategy ---------------------
ggplot() +
  geom_hline(data=sj.rel.bio%>%group_by(RELEASE_STAGE_NAME)%>%summarize(mean=mean(weight,na.rm=T)), aes(yintercept=mean, col=RELEASE_STAGE_NAME)) +
  geom_point(data=sj.rel.bio, aes(x=RELEASE_YEAR, y=weight,  colour=RELEASE_STAGE_NAME, fill=RELEASE_STAGE_NAME), size=4) +
  scale_x_continuous(breaks=seq(1995,2022,by=2)) +
  scale_y_continuous(breaks=seq(0,15,by=1)) +
  labs(y="Average weight (g)", x="Release year") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"),
        legend.position = c(0.8,0.25),
        legend.background = element_rect(fill="transparent", colour='black'))
```

<br>

<br>

## **Sources of uncertainty in marking/tagging**   {#uncertainty}

### **Otolith thermal marking** {#otoTM}

San Juan chinook have been thermally marked since 2010, according to reference specimens submitted in Otolith Manager. However, none of the reference specimens from BYs 2014-2017 and 2020 (Release Ys 2015-2018 and 2021) had "good/acceptable" quality thermal marks; 2014 specimen marks were "NA" while 2015-2017 specimens were "Not Marked". This poses uncertainty for thermal mark detection in fisheries and escapement recoveries in return/catch years 2017-onward especially given PBT is relatively new for SJ (see section \@ref(PBT)). 

```{r TM-ref-fig, echo=F, warning=F, message=F}
# FIGURE: Thermal mark quality (reference specimens) ~ year -----------------
ggplot(sj.otoTM.ref, aes(x=BROOD.YEAR, y=propn, colour=QUALITY, fill=QUALITY)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of reference specimens", x="Brood year") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

### **Parental-based tagging**  {#PBT}

Parental-based tagging (PBT) is relatively new for San Juan Chinook, beginning in 2017 but only reliable since 2019. From Eric Rondeau, MGL: 

> We’ve received what I believe to be nearly-complete brood in 2018-2021. I would say it is reliable from 2019-2021, as 2018 was missing sex ID information which complicates the process. We received ~1/3 of the brood in 2017, so I would anticipate a limited ability to PBT there as well, but not enough to reliably utilize... **I would suggest thought that 2019 is the first brood year I would recommend starting from, so for 2022 age 3.** We could probably go back to 2018 (age 4 for 2022) too if we can identify the records on sex of the samples submitted, or we can possibly run genetic sex ID marker (but hatchery records are always preferred).

Note that he says it is possible to have GSI=100% certainty, and can't definitively be prescribed to PBT-alone. Regarding assumed PBT-origin chinook from 2015-2017 recreational catch: 

> **I think it is very unlikely that those are genuinely PBT assignments.** I would suspect in this case the age was made by some other method, and that the GSI result was ~100% - it is possible the algorithm is interpreting any 100% assignment as a PBT, but this isn’t always the case (**you can have a 100% GSI**). If it wasn’t specifically marked PBT, but the GSI was 100%, I could see it being interpreted as a PBT but not actually a PBT. Do you have a few fish/Whatman/DNA IDs you could send as an example that I could verify though? We do have individuals in our baseline from San Juan from 2014 and 2015, but these are specifically marked “not brood” and no sexID was provided – these shouldn’t yield PBT IDs. 

After showing example data from a few fish exported from the CREST Biodata query:

> **I would suspect in this case that all the “100s” you are looking at are from GSI. This seems slightly more common in the San Juan assignments than I’ve seen elsewhere**, but they do pop up. Usually but not always tied to related individuals in the baseline (eg. a brother or uncle, etc.) where the genetic profile is very similar to something we have, thus making the assignment probability quite high. There are a few other reasons, but they start to get more technical, I would suspect relatedness to individuals from the 2014/2015 non-brood reference collections is most likely. **I unfortunately don’t think you’ll be able to do the hatchery/natural in San Juan until roughly this year based on PBT alone, it will likely require an additional mark to complement the GSI.** Moving ahead, we’ll be able to do so confidently (with ages), but with brood only going back to ~19, there will be limited resolution based solely on PBT until now. 

<br>

<br>






--------------------

<br>

# **San Juan Chinook in fisheries**      {#recovery}

<br>

## **Temporal Coast-wide catch in PST Waters: MRP CWT data**            {#CWTrcvy}

MRP CWT data was queried based on species and Project Code (93). MRP records indicate that San Juan chinook were not CWT'd from 1995-1998 and 2002-2012 (inclusive). There have been ~40,000 CWTs applied each year since 2013. 

In recent years () San Juan Chinook show up mostly in Canadian and Alaskan fisheries and contribute minimally to Southern US (Washington, "WDFW" or NOAA "NMFS") catch (Figure \@ref(fig:cwt-agency)). Recall that recoveries are dependent on the quality/quantity of CWT tagging and external marking. 

```{r cwt-agency, echo=F, warning=F, message=F, fig.cap='Observed (blue), estimated (green) and expanded (red) San Juan Chinook CWT recoveries by reporting agency. Estimation uses observed tags applied across fishery strata; expansion standardizes estimation by number released with CWTs and total number released.'}
# FIGURE: CWT recoveries ~ agency ------------------
ggplot(data=sj.MRPrr.sum %>% 
         filter(`(RC) Recovery Year` %in%c(2016:2022)) %>%
         group_by(`(RC) Recovery Year`, `(RC) Reporting Agency Code`)%>% 
         summarize(obsT = sum(obsT), estT=sum(estT), expT=sum(expT)) %>% 
         pivot_longer(cols=c(obsT:expT), names_to="est_type", values_to="value") %>% 
         filter(value>0)) +
  geom_point(aes(x=`(RC) Recovery Year`, y=`(RC) Reporting Agency Code`, size=value, colour=est_type), shape=16, alpha=0.7) +
  scale_size_continuous(range=c(2,9), breaks=seq(1,2500, by=500)) +
  labs(size="# of CWT recoveries") +
  theme_bw() +
  theme(legend.title = element_text(face="bold"),
        axis.title=element_text(face="bold"),
        axis.text = element_text(colour="black")) +
  facet_wrap(~factor(est_type, levels=c("obsT","estT","expT"), ordered=T), nrow=3) +
  guides(fill=guide_legend("est_type"), fill=F, colour=F)
```

<br>

Whereas historical San Juan chinook recoveries have primarily been in WCVI, Juan de Fuca and Alaskan fisheries, recently they are limited to sport fisheries around Juan de Fuca, followed by WCVI and Northern BC (Figure \@ref(fig:cwt-fishery)). Note the gap in recoveries is due to a lack of CWT releases, not a lack of fish caught. See below for more recent details in catch in Canadian waters.

```{r cwt-fishery, echo=F, warning=F, message=F, fig.cap='Expanded CWT recoveries by reporting agency fishery type. Expansion standardizes estimation (expanded across fishery strata) by number released with CWTs and total number released.'}
# FIGURE: CWT recoveries ~ agency fishery/gear ------------------

ggplot(data=sj.MRPrr.sum %>% 
         filter(`(RC) Recovery Year` %in%c(2016:2022)) %>%    # remove for all yrs
         group_by(`(RC) Recovery Year`, fishery_descr_short)%>% 
         summarize(obsT = sum(obsT), estT=sum(estT), expT=sum(expT)) %>% 
         pivot_longer(cols=c(obsT:expT), names_to="est_type", values_to="value") %>% 
         filter(value>0, est_type=="expT")) +
  geom_point(aes(x=`(RC) Recovery Year`, y=as.factor(fishery_descr_short), size=value, colour=est_type), shape=16, alpha=0.7) +
  scale_size_continuous(range=c(1,7)) +      #, breaks=seq(1,2500, by=500)
  labs(size="# of CWT recoveries (expanded):", y="", x="Recovery Year") +
  theme_bw() +
  theme(legend.position="bottom",
        legend.direction = "horizontal",
        legend.justification = "right",
        legend.title = element_text(face="bold",size=18),
        legend.text = element_text(size=16),
        axis.title=element_text(face="bold", size=19),
        axis.text = element_text(colour="black", size=17)
        ) +
  #facet_wrap(~factor(est_type, levels=c("obsT","estT","expT"),ordered = T), nrow=3) +
  guides(fill=guide_legend("est_type"), fill=F, colour=F)
```

<br>

<br>


### **CWT recoveries in Canadian fisheries**

Since 2016, most San Juan chinook CWT recoveries have been in the Area 20 sport fishery (Figure \@ref(fig:cwt-cad-fishery)).

```{r cwt-cad-fishery, fig.cap='San Juan chinook CWT recoveries (2016-2022) in Canadian fisheries where PFMA details were available. Data from MRP.'}
# Canadian fisheries CWT recoveries 
ggplot() +
  geom_polygon(data=pfmaPOLY, aes(x=long, y=lat, group=group), fill="transparent", colour="gray80", size=1, alpha=0.2) +
  geom_sf(data=ne_states(country="canada", returnclass="sf"), colour=NA, fill="gray40") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-134, -122), ylim=c(48, 55)) +
  geom_jitter(data=rcvy.PFMA.spatial%>%group_by(PFMA_resolved,gear)%>%
                summarize(totalExp=unique(total_expT), totalEst=unique(total_estT),lat=unique(lat),long=unique(long)), 
             aes(x=long, y=lat, size=totalExp, shape=gear, colour=gear, fill=gear), alpha=0.8, width=0.2) +
  labs(shape="Gear", size="Expanded recoveries", colour="Gear", fill="Gear") +
  scale_size_continuous(range = c(2,6)) +
  theme_bw() +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.text = element_text(colour="white", size=15),
    legend.title = element_text(colour="white", face="bold", size=17),
    legend.position = c(0.8,0.8),
    legend.background = element_rect(fill="transparent"),
    legend.key = element_rect(fill="transparent"),
    panel.grid.major = element_blank())
```

Of the San Juan Chinook caught in Canadian fisheries, most are 4 year olds. There is no clear geographic trend in age at recovery, rather ages are probably reflective of temporal or gear-based trends. 

```{r cwt-cad-age, fig.cap='Age at recovery of San Juan chinook CWT recoveries (2016-2022) in Canadian fisheries where PFMA details were available. Data from MRP.'}
# Age scatterplot map:
ggplot() +
  geom_polygon(data=pfmaPOLY, aes(x=long, y=lat, group=group), fill="transparent", colour="gray80", size=1, alpha=0.2) +
  geom_sf(data=ne_states(country="canada", returnclass="sf"), colour=NA, fill="gray40") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-134, -122), ylim=c(48, 55)) +
  #geom_point(data=pfmaLL, aes(x=long_rollup, y=lat_rollup), size=5, colour="blue") +
  geom_scatterpie(aes(x=long, y=lat, group=PFMA_resolved), 
                  data=rcvy.PFMA.spatialGG%>%mutate(across(`3`:`5`, ~case_when(is.na(.)~0,TRUE~as.numeric(.)))), 
                  cols=c("3","4","5"), alpha=0.8) +
  scale_fill_discrete("Age") +
  theme_bw() +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.text = element_text(colour="white", size=15),
    legend.title = element_text(colour="white", face="bold", size=17),
    legend.position = c(0.8,0.8),
    legend.background = element_rect(fill="transparent"),
    legend.key = element_rect(fill="transparent"),
    panel.grid.major = element_blank())
```



## **Canadian recreational fisheries: creel data**   {#recCatch}

### **Catch estimates**    {#catESt}

Chinook kept catch has been relativey constant in recent years. Releases, both legal and sub-legal, increased significantly in 2022. 

```{r}
  ggplot(data=catEst%>%filter(grepl("SALMON",SPECIES), PFMA=="PFMA 20")%>%group_by(SPECIES, YEAR, DISPOSITION)%>%
           summarize(sum_est=sum(ESTIMATE,na.rm=T), sum_se=sum(STANDARD_ERROR,na.rm=T))%>%
           filter(!grepl("ATLANTIC | TROUT",SPECIES)),
         aes(x=as.factor(YEAR), y=sum_est, fill=DISPOSITION)) +
    geom_bar(stat="identity", position=position_dodge(),alpha=0.8) +
    geom_errorbar(aes(x=as.factor(YEAR), ymin=sum_est-sum_se, ymax=sum_est+sum_se, colour=DISPOSITION), position=position_dodge(width=0.9), width=0) +
    labs(y="Total estimate of fish") +
    theme_bw() +
    theme(axis.text = element_text(colour="black", size=17),
          axis.text.x = element_text(angle=45, hjust=1),
          axis.title = element_text(face="bold", size=19),
          axis.title.x = element_blank(),
          legend.position = c(0.8,0.2),
          #legend.direction = "horizontal",
          legend.title = element_blank(),
          legend.text = element_text(margin=margin(r=20, unit="pt"), size=15),
          strip.text = element_text(size=15))+
    guides(colour = guide_legend(override.aes=list(colour=NA))) +
  facet_wrap(~SPECIES, scales="free", nrow=3)
```

```{r}
  ggplot(data=catEst%>%filter(SPECIES=="CHINOOK SALMON", PFMA=="PFMA 20")%>%group_by(YEAR,CREEL_SUB_AREA,DISPOSITION)%>%
           summarize(sum_est=sum(ESTIMATE,na.rm=T), sum_se=sum(STANDARD_ERROR,na.rm=T)),
         aes(x=as.factor(YEAR), y=sum_est, fill=DISPOSITION)) +
    geom_bar(stat="identity", position=position_dodge(),alpha=0.8) +
    geom_errorbar(aes(x=as.factor(YEAR), ymin=sum_est-sum_se, ymax=sum_est+sum_se, colour=DISPOSITION), position=position_dodge(width=0.9), width=0) +
    labs(y="Total estimate of fish") +
    theme_bw() +
    theme(axis.text = element_text(colour="black", size=17),
          axis.text.x = element_text(angle=45, hjust=1),
          axis.title = element_text(face="bold", size=19),
          axis.title.x = element_blank(),
          legend.position = c(0.8,0.2),
          #legend.direction = "horizontal",
          legend.title = element_blank(),
          legend.text = element_text(margin=margin(r=20, unit="pt"), size=15),
          strip.text = element_text(size=15))+
    guides(colour = guide_legend(override.aes=list(colour=NA))) +
  facet_wrap(~CREEL_SUB_AREA, scales="free", nrow=3)
```

### **What is composition of Area 20 catch?**

```{r}
ggplot(data=pfma20.stock, aes(x=reorder(RESOLVED_STOCK_ROLLUP,-rollup_propn), y=rollup_propn, fill=RESOLVED_STOCK_ROLLUP)) +
  geom_bar(stat="identity") +
  scale_y_continuous(labels = scales::percent)+
  labs(x="Stock rollup", y="Proportion of biosamples in Area 20") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45,hjust=1),
        axis.text = element_text(colour="black", size=11),
        axis.title = element_text(face="bold", size=13),
        legend.position = "none") +
  facet_wrap(~YEAR)
```

```{r}
ggplot(data=pfma20.SJ, aes(x=SJfocal, y=year_propn, fill=SJfocal)) +
  geom_bar(stat="identity") +
  scale_y_continuous(labels = scales::percent)+
  labs(y="Proportion of biosamples in Area 20") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(colour="black",size=12),
        axis.title = element_text(face="bold",size=14),
        legend.position = "none") + 
  facet_wrap(~YEAR)
```







### **What proportion of recreational catch is composed of San Juan Chinook?**

While San Juan chinook show up in several PFMAs along WCVI and NEVI, they contribute <15% of the total recreational catch in any given area and year. They are most consistently caught in PFMAs 20, 21, 23, 25, 26, and 123 (Figure \@ref(fig:AArec-comp)). 

```{r AArec-comp, echo=F, warning=F, message=F, fig.cap='Proportion of San Juan/Port Renfrew chinook caught in all recreational fisheries. Data from a random sample of chinook identified by CWT, otolith thermal mark and/or DNA (GSI & PBT) from CREST.'}
ggplot(data=sj.crestrcvy.AAs%>% filter(origin_rollup!="Other/unk"), aes(x=YEAR, y=propn, fill=origin_rollup, colour=origin_rollup)) +
  geom_bar(stat="identity", position="stack", alpha=0.5) +
  labs(x="Catch year", y="Proportion of sport catch biosamples (%)") +
  scale_y_continuous(limits=c(0,15)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=45, hjust=1, colour="black"),
        axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        plot.caption = element_text(hjust=0, face="italic")) +
  facet_wrap(.~AREA)
```

<br>

### **Are San Juan Chinook caught in recreational fisheries hatchery or natural-origin?**  {#recCatchOrigin}

The contribution of hatchery- and natural-origin San Juan chinook to recreational fishery catch varies over years, and is difficult to track due to inconsistent marking/tagging practices over time. When assessing the CREST catch data by catch year, hatchery SJ Chinook contribute up to 50% (2021) of recreational catch, but as low as ~20% (note, 0% hatchery in 2014 is highly suspicious) (Figure \@ref(fig:sj-rec-origCY)). 

```{r sj-rec-origCY, echo=F, message=F, warning=F, fig.cap='Of the San Juan Chinook caught in recreational fisheries, the proportion of which are hatchery (Y, blue) or unknown (unk, pink) origin. Overlapping shading in 2020-2021 indicates potential expansion of hatchery-origin Chinook due to incomplete parental-based tagging of BY2017 (38% tagged).'}
# FIGURE: CREST catch origin by CY -----------------
ggplot() +
  geom_bar(data=sj.hoCY, 
           aes(x=`Catch Year`, y=propn, group=HATCHERY_ORIGIN, fill=HATCHERY_ORIGIN, colour=HATCHERY_ORIGIN), 
           stat="identity", position="stack", alpha=0.5, size=1) +
  geom_bar(data=sj.ho.expCY, 
           aes(x=`Catch Year`, y=propn_expanded, group=HATCHERY_ORIGIN, fill=HATCHERY_ORIGIN, colour=HATCHERY_ORIGIN), 
           stat="identity", position="stack", alpha=0.5, size=1) +
  scale_x_continuous(breaks=seq(2014,2021,by=1)) +
  labs(x="Catch year", y="Proportion of sport catch biosamples (%)") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        panel.grid = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        plot.caption = element_text(face="italic", hjust=0))
```

However, using the age at catch information to back-calculate to brood year contributing to annual catch, we can see of the Chinook caught that came from BY 2017 and 2018, most were hatchery-origin (Figure \@ref(fig:sj-rec-origBY)). This estimate may likely be higher, as BYs 2014-2017 and 2020 had poor/no otolith thermal marks applied.  

```{r sj-rec-origBY, echo=F, message=F, warning=F, fig.cap='Of the San Juan Chinook caught in recreational fisheries, the proportion of which are hatchery (Y, blue) or unknown (unk, pink) origin. Overlapping shading indicates potential expansion of hatchery-origin Chinook due to incomplete parental-based tagging of BY2017 (38% tagged). Black dots indicate years with incomplete thermal marking releases, thus the hatchery component may be higher than given.'}
# FIGURE: CREST catch origin by BY (to compare to bad marking years) -----------------
ggplot() +
  geom_bar(data=sj.hoBY, 
           aes(x=`Brood Year`, y=propn, group=HATCHERY_ORIGIN, fill=HATCHERY_ORIGIN, colour=HATCHERY_ORIGIN), 
           stat="identity", position="stack", alpha=0.5, size=1) +
  geom_bar(data=sj.ho.expBY, 
           aes(x=`Brood Year`, y=propn_expanded, group=HATCHERY_ORIGIN, fill=HATCHERY_ORIGIN, colour=HATCHERY_ORIGIN), 
           stat="identity", position="stack", alpha=0.5, size=1) +
  geom_point(data=sj.otoTM.refNAs, aes(x=as.numeric(BROOD.YEAR), y=link), size=2) +
  scale_x_continuous(breaks=seq(2010,2020,by=1)) +
  labs(x="Brood year catch originated from", y="Proportion of sport catch biosamples (%)") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        panel.grid = element_blank(),
        legend.position = "bottom",
        legend.direction = "horizontal",
        plot.caption = element_text(face="italic", hjust=0))
```

<br>

## **What is the composition of Area 20 (Port Renfrew) fisheries?**    {#a20catch}

Prior to Chinook management measures implemented in 2019, the composition of the sport fishery west of Juan de Fuca (creel subareas 20A,B,C,E) mostly consisted of US catch, Fraser Summer 4.1 and SWVI stocks (Table \@ref(tab:a20-comp-tab) and Figure \@ref(fig:a20-comp-fig)). 

```{r a20-comp-tab, echo=F, warning=F, message=F}
# TABLE: Area 20 stock comp -----------------
a20.crest.comp %>%
  mutate(propn=round(propn,2)*100)  %>%
  kbl(align="c", caption = "Area 20 (subareas 20A,B,C,E) Chinook catch stock composition. Data from CREST.") %>%
  kable_paper("hover", full_width=T, position = "center") %>%
  collapse_rows(columns=c(1,2), valign="middle")
```

```{r a20-comp-fig, echo=F, warning=F, message=F, fig.cap='Area 20 (subareas 20A,B,C,E) Chinook catch stock composition. Data from CREST.', out.width="100%"}
# FIGURE: Area 20 stock comp -----------------
ggplot(data=a20.crest.comp, aes(x=YEAR, y=propn, group=region, fill=region, colour=region)) +
  geom_bar(stat="identity", position="stack", alpha=0.8) +
  labs(x="Catch year", y="Proportion of biosamples (%)", fill="Stock", colour="Stock") +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

<br>

<br>






--------------------

<br>

# **Consequences of mark-selective fisheries for San Juan Chinook** 

<br>

<br>


--------------------

<br>

# **In-River juvenile assessments**

<br>

Not much work has occurred for juvenile assessments on the San Juan. An RST was operated in 2006 and 2007 (although 2007 data are not available currently). The 2006 RST was operated from March 15 to June 11.  

```{r sj-juvi-fig, fig.cap='Estimated number of naturally-produced smolts from parental offspring. Calculated assuming 40% female sex ratio, 3500 eggs per female and 20% freswater egg-smolt survival.'}
# FIGURE: SJ Chinook juvis ----------------------- 
ggplot() +
  geom_bar(aes(x=2006,y=522023),stat="identity", fill="red", colour="black",alpha=0.5) +

  geom_bar(data=sj.esc%>%filter(waterbody_name%in%c("SAN JUAN RIVER","San Juan"), Species=="Chinook", est_type=="Natural spawners")%>%group_by(analysis_year)%>%summarize(total_adults=sum(n))%>%mutate(females=total_adults*0.4, egg_dep=females*3500, smolts=egg_dep*0.2, smolt_year=analysis_year+1), 
           aes(x=as.numeric(smolt_year), y=as.numeric(smolts)),
           stat="identity", size=0.7, width=1, colour="transparent", fill="dodger blue", alpha=0.7) +
  
  scale_x_continuous(breaks=seq(1930,2023,by=5)) +
  labs(x="Outmigration Year", y="Est Number of naturally-produced smolts") +
  theme_bw() +
  theme(axis.text = element_text(colour="black", size=10),
        axis.title = element_text(face="bold", size=12),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(colour="gray70"),
        legend.position = c(0.8,0.9),
        legend.background = element_rect(colour="black"),
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        plot.caption = element_text(hjust=0, face="italic"))
```










